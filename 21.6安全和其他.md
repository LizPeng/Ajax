## 21.6安全

从普遍意义上探讨一些基本的问题。

首先，可以通过XHR访问的任何URL也可以通过浏览器或服务器来访问。下面的URL就是一个例子。

/getuserinfo.php?id=23

如果是向这个URL发送请求，可以想象结果会返回ID为23的用户的某些数据。谁也无法保证别人不会将这个URL的用户ID修改为24、56或其他值。因此，getuserinfo.php文件必须知道请求者是否真的有权限要请求的数据；否则，你的服务器就会门户大开，任何人的数据都可能被泄漏出去。

对于未被授权系统有权访问某个资源的情况，我们称之为CSRF（Cross-Site Request Forgery，跨站点请求伪造）。未被授权系统会伪装自己，让处理请求的服务器认为它是合法的。

为确保通过XHR访问的URL安全，通行的做法就是验证发送请求者是否有权限访问相应的资源。有下列几种方式可供选择。

- 要求以SSL连接来访问可以通过XHR请求的资源。
- 要求每一次请求都要附带经过相应算法计算得到的验证码。

请注意，下列措施对防范CSRF攻击不起作用

- 要求发送POST而不是GET请求---很容易改变。
- 检查来源URL以确定是否可信---来源记录很容易伪造。
- 基于cookie信息进行验证---容易伪造。

XHR对象也提供了一些安全机制，虽然表面上可以保证安全，但实际上不可靠。实际上，前面介绍的open()方法还能再接收两个参数：要随请求一起发送的用户名和密码。带有这两个参数的请求可以通过SSL发送给服务器上的页面，如下：

    xhr.open('get', 'example.php', true, 'username', 'passord');//不要这样做！！


## 21.7 小结

Ajax是无需刷新页面就能够从服务器取得数据的一种方法。有以下总结

- 负责Ajax运作的核心对象是XHMLHttpRequest(XHR)对象。
- XHR对象you微软最早在IE5引入，用于通过JavaScript从服务器获取XML数据。

同源策略是对XHR的一个主要约束，它为通信设置了“相同的域，相同的端口，相同的协议”这一限制。视图访问上述限制之外的资源，都会引发安全错误，除非采用被认可的跨域解决方案。这个解决方案叫CORS(Cross-Origin Resource Sharing，跨源资源共享），IE8通过XDomainRequest对象支持CORS,其他浏览器通过XHR对象原生支持CORS.图像Ping和JSONP是另外两种跨域通信技术，但不如CORS稳妥。


Comet是对Ajax的进一步扩展，让服务器几乎能够实时地向客户端推送数据。实现Comet的手段主要有两个：长轮询和HTTP流。所有浏览器都支持长轮询，而只有部分浏览器原生支持HTTP流.SSE（Server-Sent Events，服务器发送事件）是一种实现Comet交互的浏览器API，既支持长轮询，也支持HTTP流。

Web Sokcets是一种与服务器进行全双工、双向通信的信道。与其他方案不同，Web Sockets不适用HTTP协议，而使用一种自定义的协议。这种协议专门为快速传递小数据设计。虽然要求使用不同的Web服务器，但却具有速度上的优势。

